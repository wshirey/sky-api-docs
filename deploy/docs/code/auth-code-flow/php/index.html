<!DOCTYPE html>

  <html lang="en" class="">
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Blackbaud SKY API Developer Portal | Authorization Code Flow - PHP</title>
      <link rel="icon" href="/img/favicon.ico" type="image/ico">

      
        <link rel="stylesheet" href="https://sky.blackbaudcdn.net/skyux/1.16.0-4/css/sky-bundle.css">
<link rel="stylesheet" href="/css/app.css">
      
      

      
        <link rel="stylesheet" href="/assets/css/custom.css">
      
        <link rel="stylesheet" href="/assets/css/entity-reference.css">
      

      


      <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
      <![endif]-->

      
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2418840-1', 'auto');
  ga('send', 'pageview');
</script>
      

    </head>
    <body data-base="/" class="bb-omnibar-height-padding ">

      
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-W56QP9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-W56QP9');</script>
      

      <div id="top"></div>

      
        

          <div id="ng-stache" ng-controller="NavController"  class="bb-navbar">
            <bb-navbar>
              <div class="container">
                <div class="row">
                  <div class="col-sm-12">
                    <ul class="nav navbar-nav navbar-left">
  <li>
    <a href="https://developer.sky.blackbaud.com/">
      Home
    </a>
  </li>
  <li class="dropdown">
    <a href="/docs/getting-started/" class="dropdown-toggle">
      Documentation
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="/docs/getting-started/">Getting Started</a>
      </li>
      <li>
        <a href="/docs/createapp/">Applications</a>
      </li>
      <li>
        <a href="/docs/addins/">Add-ins</a>
      </li>
      <li>
        <a href="/docs/authorization/">Authorization</a>
      </li>
      <li>
        <a href="/docs/basics/">Basics</a>
      </li>
      <li>
       <a href="/docs/code/">Code Samples</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a href="https://developer.sky.blackbaud.com/docs/services/" class="dropdown-toggle">
      API
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="https://developer.sky.blackbaud.com/docs/services/">Endpoint Reference</a>
      </li>
      <li>
        <a href="/api/entity-reference/">Entity Reference</a>
      </li>
      <li>
        <a href="https://developer.sky.blackbaud.com/products/">Products</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a href="https://developer.sky.blackbaud.com/developer/" class="dropdown-toggle">
      Developer Account
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="https://developer.sky.blackbaud.com/developer/">My Profile</a>
      </li>
      <li>
        <a href="https://developer.blackbaud.com/apps">My Applications</a>
      </li>
      <li>
        <a href="https://developer.sky.blackbaud.com/developer/analytics/">Analytics</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a href="/support/changelog/" class="dropdown-toggle">
      Support
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
       <li>
        <a href="https://community.blackbaud.com/developer">Community</a>
      </li>
      <li>
        <a href="/support/changelog/">Changelog</a>
      </li>
       <li>
        <a href="/support/issues/">Issues</a>
      </li>
      <li>
        <a href="/support/ideas/">Ideas</a>
      </li>
      <li>
        <a href="/support/faq/">FAQ</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="https://skyapi.statuspage.io">Status</a>
  </li>
</ul>
                    
                    
                  </div>
                </div>
              </div>
            </bb-navbar>
          </div>

        
      

      

      
      
        
    <div id="wrap-breadcrumbs">
        <div class="container">
            <ul class="breadcrumb">
                
                    
                        <li><a href="/">Home</a></li>
                    
                
                    
                        <li><a href="/docs/">Documentation</a></li>
                    
                
                    
                        <li><a href="/docs/code/">Code Samples</a></li>
                    
                
                    
                        <li><a href="/docs/code/auth-code-flow/">Authorization Code Flow</a></li>
                    
                
                    
                        <li class="active">PHP</li>
                    
                
            </ul>
        </div>
    </div>

      

      
        
          

<div class="content">
  <div class="container">
    <div class="row">
      <div class="col-sm-12">
        
          
<!-- STACHE MARKED -->
<div class="pull-right partial-edit-header">
    <a href="#disqus_thread" target="_self" class="edit-link btn btn-primary">
        Comments
    </a>
</div><div class="pull-right partial-edit-header">
    <a href="https://github.com/blackbaud/sky-api-docs/blob/develop/content/docs/code/auth-code-flow/php/index.md" target="_blank" class="edit-link btn btn-primary" rel="noopener noreferrer">
        <i class="fa fa-pencil"></i> Edit in GitHub
    </a>
</div>

<h1 id="authorization-code-flow-php">Authorization Code Flow - PHP</h1>
<p><a class="btn btn-primary" href="https://github.com/blackbaud/sky-api-tutorial-auth-code-php/" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i> GitHub</a></p>
<h2 id="overview">Overview</h2>
<p>We use OAuth 2.0 to secure access to a user&apos;s SKY API data. In this tutorial we obtain user authorization using the <a href="/docs/authorization/auth-code-flow/">Authorization Code Flow</a>. From the user&apos;s perspective, the user authenticates as a Blackbaud user with the normal credentials for Blackbaud NXT and then authorizes (or denies) your application. To accomplish this, your application obtains an authorization code from the Blackbaud Authorization Service. The authorization code is then exchanged for an access token that signs requests to the SKY API on behalf of the user. The exchange involves your registered application&apos;s <strong>Application secret</strong>. For security reasons, the exchange is done through direct server-to-server communication. For this reason, we use <a href="https://secure.php.net/">PHP</a> on the server.</p>
<p>In this tutorial, we will accomplish the following tasks:</p>
<ul>
<li>Ensure that you signed up for a developer account and obtained your subscription to an API product.</li>
<li>Register an application with SKY API.</li>
<li>Obtain authorization to access user data for a specific tenant.</li>
<li>Retrieve data from a SKY API endpoint.</li>
</ul>
<p>For this tutorial, we strip down the user interface to highlight the Authorization Code Flow. Our <a href="/docs/code/">Barkbaud code sample</a> provides a rich user interface using <a href="http://skyux.developer.blackbaud.com/" target="blank">SKY UX</a>.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>A server such as your local machine that is capable of running PHP.  We recommend <a href="https://www.mamp.info/en/">MAMP</a>.</li>
<li>Familiarity using a command line interface (CLI) such as Terminal or Windows Command Prompt.</li>
<li>Sign up for a <a href="https://github.com">GitHub</a> account, if you don&apos;t already have one. The source code for this tutorial is stored in GitHub repository.</li>
<li>Install <a href="https://git-scm.com/">Git</a> and have the ability to clone or fork a repo.</li>
<li>A reliable Internet connection.</li>
</ol>
<h2 id="step-1-mdash-get-your-keys">Step 1 &#x2014; Get Your Keys</h2>
<p>If you have not already done so, complete the <a href="/docs/getting-started/">Getting Started guide</a>. The tutorial guides you through signing up for a Blackbaud developer account and requesting a subscription to an API product. After you are approved, your subscription contains a <strong>Primary key</strong> and <strong>Secondary key</strong>. You can use either key as the subscription key value for the <code>Bb-Api-Subscription-Key</code> request header in calls to the API.</p>
<h3 id="developer-sandbox-tenant">Developer Sandbox Tenant</h3>
<p>After your subscription is approved, your developer account can access the Developer Sandbox tenant that represents a sample database. With this particular tenant, keep in mind that you share this sandbox with other developers. You can access the Developer Sandbox tenant and learn the various endpoints through the interactive SKY API Console within the <a href="https://developer.sky.blackbaud.com/docs/services/" target="_blank" rel="noopener noreferrer">API Reference</a>.</p>
<h2 id="step-2-mdash-register-your-app">Step 2 &#x2014; Register Your App</h2>
<p style="text-align: left;">To call the SKY API, first register your application to obtain its unique set of credentials, which your users will use to enable your app to access their data</p>

<div class="row">
  <div class="col-md-6" style="text-align: left;">
    <ol>
      <li><p>From <a href="https://developer.blackbaud.com/apps" target="_blank" rel="noopener noreferrer">My Applications</a>, click <b>Register app</b>.</p></li>
      <li><p>Enter the name, description, and logo of your application, as well as your organization&apos;s name. This information appears for users when they enable access to your application during the <a href="/docs/authorization/" target="_blank" rel="noopener noreferrer">authorization process</a> or in their product.</p></li>
      <li><p>In the <strong>Application website URL</strong> field, enter where users can learn more about your application online.</p></li>
      <li>
        <p>Specify the URIs to use to redirect users back to your application during the <a href="/docs/authorization/" target="_blank" rel="noopener noreferrer">authorization process</a>.
        <strong>Note:</strong> The URIs must be absolute and use HTTPS. However, we do support <code>http://localhost:port</code> or <code>http://127.0.0.1:port</code> for local development.</p>
        <p><bb-alert bb-alert-type="warning"><strong>Important!&#xA0;&#xA0;</strong> When your application requests authorization to access a Blackbaud user&apos;s data, it includes a <code>redirect_uri</code> parameter in its query string.  To authorize your application, this value must match <i>exactly</i> against one of the URIs you provide, including any trailing slashes. For more information, see <a href="/docs/authorization/common-auth-issues" target="_blank" rel="noopener noreferrer">common authorization issues</a>.</bb-alert></p>
      </li>
      <li><p>Click <b>Save</b>.</p></li>
    </ol>
  </div>
  <div class="col-md-6" style="text-align: left;">
    <p><img width="100%" src="/assets/img/add_app_top.png" class="img-responsive"></p>
  </div>
</div>

<div class="row">
    <div class="col-md-12" style="text-align: left;">
        <p>After you register an app, note the ID and secret that appear under <b>Application Credentials</b>. These credentials are unique to your application, and verify its identity during the <a href="/docs/authorization/" target="_blank" rel="noopener noreferrer">authorization process</a>.</p>
        <div class="row">
            <div class="col-md-6">
                <p><b>ID -</b><br>Your application&apos;s unique identifier. Your users will need this ID to enable your application to access their Blackbaud data. You can&apos;t modify this ID; if you need to change it for any reason, delete the application and re-register it.</p>
            </div>
            <div class="col-md-6">
                <p><b>Secret -</b><br>The key your application provides when it requests an access token to call the SKY API during the <a href="/docs/authorization/" target="_blank" rel="noopener noreferrer">authorization process</a>. This value is sensitive, so <b>don&apos;t</b> share it with anyone else! To display the secret, click <b>Show</b>.</p>
            </div>
        </div>
        <p><img src="/assets/img/app_credentials_sample.png" class="img-responsive"></p>
        <p><bb-alert bb-alert-type="warning"><strong><em>Very Important!&#xA0;&#xA0;</em></strong> Keep the application secret private and safe! If the secret is compromised, <a href="/docs/createapp/#regenerate-your-secret" target="_blank" rel="noopener noreferrer">regenerate it.</a> Blackbaud reserves the right to remove or deactivate your application to protect customer data.</bb-alert></p>
    </div>
</div>

<h2 id="step-3-mdash-grab-the-source-code">Step 3 &#x2014; Grab the Source Code</h2>
<p>The <a href="https://github.com/blackbaud/sky-api-tutorial-auth-code-php/" target="_blank" rel="noopener noreferrer">sky-api-tutorial-auth-code-php</a> repo on GitHub provides a starter project to work through the Authorization Code Flow.</p>
<p>Use a command prompt to clone the <code>sky-api-tutorial-auth-code-php</code> repo which creates a working directory by the same name that contains the code for the tutorial:</p>
    <pre><code class="language-git">$ git clone https://github.com/blackbaud/sky-api-tutorial-auth-code-php.git</code></pre>

<h2 id="step-4-mdash-prepare-your-environment">Step 4 &#x2014; Prepare Your Environment</h2>
<ol>
    <li>Open the <strong>sky-api-tutorial-auth-code-php</strong> working directory and copy the configuration file <strong>config.php.sample</strong> as <strong>config.php</strong>. The <strong>config.php</strong> file contains the application&apos;s environment variables for the PHP environment.</li>
    <li>
      <p>Update <strong>config.php</strong> with the following values:</p>
      <div class="table-responsive">
        <table class="table table-striped table-condensed">
          <tr>
            <td><strong><code>AUTH_CLIENT_ID</code></strong></td>
            <td>
              Your registered application&apos;s <strong>Application ID</strong> (from Step 2).<br>
              (See, <a href="https://apidocs.sky.blackbaud.com/docs/apps/">Managing your apps</a>.)
            </td>
          </tr>
          <tr>
            <td><strong><code>AUTH_CLIENT_SECRET</code></strong></td>
            <td>
              Your registered application&apos;s <strong>Application Secret</strong> (from Step 2).<br>
              (See, <a href="https://apidocs.sky.blackbaud.com/docs/apps/">Managing your apps</a>.)
            </td>
          </tr>
          <tr>
            <td><strong><code>AUTH_REDIRECT_URI</code></strong></td>
            <td>
            One of your registered application&apos;s <strong>Redirect URIs</strong> (from Step 2).<br>
            For this tutorial, enter <code>http://localhost:8888/auth/callback.php</code>. <br>
            </td>
          </tr>
          <tr>
            <td><strong><code>AUTH_SUBSCRIPTION_KEY</code></strong></td>
            <td>
            Your Blackbaud Developer <strong>Subscription Key</strong>.<br>
            Use either the <strong>Primary key</strong> or <strong>Secondary key</strong>, visible on your <a href="https://developer.sky.blackbaud.com/developer">Blackbaud Developer Profile</a>.
            </td>
          </tr>
        </table>
      </div>
    </li>
    <li>Save the config file.</li>
    <li>Review the <strong>.gitignore</strong> file. The purpose of the file is to specify the untracked files to ignore. Note that <strong>config.php</strong> file is ignored. This prevents the config file from being synced to GitHub and protects your registered application&apos;s keys and other sensitive data from being exposed.</li>
</ol>

<h2 id="step-5-mdash-install-and-configure-mamp">Step 5 &#x2014; Install and Configure MAMP</h2>
<p>After you have your subscription key, Application ID, Application secret, and the <a href="https://github.com/blackbaud/sky-api-tutorial-auth-code-php/" target="_blank" rel="noopener noreferrer">sky-api-auth-tutorial-php</a> source code, It&apos;s time to establish your development environment. Since we are using the <a href="/docs/authorization/auth-code-flow/">Authorization Code Flow</a>, we need to use a server-side software platform. For this tutorial, we will use PHP with <a href="https://www.mamp.info/en/">MAMP</a> to serve the project locally.</p>
<ol>
<li>Download and install <a href="https://www.mamp.info/en/" target="blank">MAMP</a>.</li>
<li><p>Launch MAMP and edit the following in <strong><code>Preferences</code></strong>.</p>
<div class="table-responsive">
 <table class="table table-striped table-hover">
   <thead> 
     <tr>
       <th>Tab</th>
       <th>Field</th>
       <th>Description</th>
     </tr>
   </thead>
   <tbody>
     <tr>
       <td><strong><code>Web Server</code></strong></td>
       <td><strong><code>Document Root</code></strong></td>
       <td>Change this path to point at your cloned <strong><code>sky-api-tutorial-auth-code-php</code></strong> directory.</td>
     </tr>
   </tbody>
 </table>
</div>
<div><img src="/assets/img/auth_tutorial_mamp.png" alt="MAMP Document Root" title="Document Root settings in MAMP"></div></li>
<li>Select <code>Ok</code> and <code>Start Servers</code>.</li>
<li>In a Web browser, navigate to <a href="http://localhost:8888" target="blank">localhost:8888</a>. The Web server displays our app.</li>
</ol>
<h2 id="application-starting-point">Application Starting Point</h2>
<ol>
<li>Open the <strong>index.html</strong> file. MAMP serves this file as our applications root where we initialize our app and load assets to build our page.</li>

<li>The <code>body</code> tag includes an attribute named <code>ng-app</code>. The front-end of our application uses <a href="https://angularjs.org/">AngularJS</a> to interact with our PHP server. 
</li>
    <pre><code class="language-markup">&lt;!-- INITIALIZE THE APP --&gt;
    &lt;body ng-app=&quot;AuthCodeFlowTutorial&quot;&gt;
        &lt;div class=&quot;container&quot; ng-controller=&quot;ConstituentCtrl&quot; ng-cloak&gt;
        ... </code></pre>

<li>
    <p>Open your browser to <a href="http://localhost:8888" target="http://localhost:8888">http://localhost:8888</a> to request the Home page. When the front page loads, the AngularJS on the Home page (<strong>index.html</strong>) makes a request to the <code>/auth/authenticated.php</code> endpoint:</p>
<pre><code class="language-javascript">(function (angular) {
  &apos;use strict&apos;;

  angular.module(&apos;AuthCodeFlowTutorial&apos;, [])
    .controller(&apos;ConstituentCtrl&apos;, function ($scope, $http, $window) {

      // Check user access token.
      $http.get(&apos;/auth/authenticated.php&apos;).then(function (res) {
        $scope.isAuthenticated = res.data.authenticated;
        if ($scope.isAuthenticated === false) {
          $scope.isReady = true;
          return;
        }
        ...</code></pre>
    <p>The call to the endpoint routes to the corresponding php page (<strong>/auth/authenticated.php</strong>) and returns a Boolean representing the current user&apos;s authentication status.  First, it requires and loads the <strong>/includes/blackbaud/blackbuad.php</strong> file.</p>
<pre><code class="language-php">&lt;?php
    require_once &apos;../includes/blackbaud/blackbaud.php&apos;;

    echo json_encode(array(
    &apos;authenticated&apos; =&gt; blackbaud\Session::isAuthenticated()
    ));
        ...</code></pre>
</li>
<li>
    <p>Open the <strong>/includes/blackbaud/blackbaud.php</strong> file. The PHP code pulls in the rest of our required controllers, config environment variables, and http library for making API requests.  We can see <code>**require_once &apos;session.php&apos;;**</code> pulls in the <strong>includes/blackbaud/session.php</strong> file.</p>
<pre>
    <code class="language-php">&lt;?php
    // Error reporting, for development only.
    ini_set(&apos;display_errors&apos;, 1);
    ini_set(&apos;display_startup_errors&apos;, 1);
    error_reporting(E_ALL);

    require_once &apos;session.php&apos;;
    require_once join(DIRECTORY_SEPARATOR, array($_SERVER[&apos;DOCUMENT_ROOT&apos;], &apos;config.php&apos;));
    require_once join(DIRECTORY_SEPARATOR, array(&apos;api&apos;, &apos;constituents.php&apos;));
    require_once &apos;auth.php&apos;;
    require_once &apos;http.php&apos;;
        ...</code></pre>
</li>
<li>
    <p>Open the <strong>/includes/blackbaud/session.php</strong> file.  It begins by defining our <strong>namespace blackbaud</strong>, allowing the methods and variables defined beneath it to be accessed by any other classes also under that namespace.  Our original call to <code>/auth/authenticated/</code>  made use of the <code>isAuthenticated()</code> method in this Session object.  This method checks for the existance of a PHP <code>$_SESSION</code> object and looks for an <code>access_token</code>. If the application has not yet been authorized by the end user, then <code>IsAuthenticated()</code> will return <code>false</code>.</p>

<pre><code class="language-php">&lt;?php
    public static function isAuthenticated() {
    return isset($_SESSION[self::$tokenName]) &amp;&amp; isset($_SESSION[self::$tokenName][&apos;access_token&apos;]);
    }
        ...</code></pre>
</li>
</ol>

<h2 id="display-the-log-in-button">Display the Log in button</h2>
<ol>
<li><p>If the user is not authenticated, a <strong>Log in</strong> button is displayed.</p>
<p><bb-alert bb-alert-type="info"><strong><em>Note:</em></strong> The browser may display a warning that the connection is not private. For this tutorial, you can ignore this message. To proceed, select <strong>Show advanced</strong> and then select <strong>Proceed to localhost (unsafe)</strong>.</bb-alert></p>
<img src="/assets/img/auth_tutorial_login_php.png" alt="Login" title="Log in"></li>
<li><p>Open the <strong>index.html</strong> file. Notice that the <code>body</code> tag includes an attribute named <code>ng-app</code>. The front-end of our application uses AngularJS to interact with our Web server routes. The <code>div.container</code> element includes an attribute named <code>ng-controller</code> which references an AngularJS controller to handle the model data.</p>
<pre><code class="language-markup">&lt;body ng-app=&quot;AuthCodeFlowTutorial&quot;&gt;
  &lt;div class=&quot;container&quot; ng-controller=&quot;ConstituentCtrl&quot; ng-cloak&gt;
    ...</code></pre></li>
<li><p>When the Home page first loads the app will not have received authorization from the user to access their SKY API data. As a result the <code>isAuthenticated</code> scope variable will be <code>false</code> and the Home page&apos;s Angular HTML template displays the <strong>Log in</strong> button.</p>
<pre><code class="language-markup">&lt;div ng-if=&quot;!isAuthenticated&quot;&gt;
    &lt;a href=&quot;/auth/login&quot; class=&quot;btn btn-primary&quot;&gt;Log in&lt;/a&gt;
&lt;/div&gt;
...</code></pre></li>
</ol>

<h2 id="obtain-an-access-token">Obtain an Access Token</h2>
<ol>
<li>Open <strong>/includes/blackbaud/auth.php</strong>.</li>
<li><p>When the user selects the <strong>Log in</strong> button, a call is made to <code>auth/login.php</code>, which redirects the request to <code>/includes/blackbaud/auth.php</code> file. Here, the <code>redirect()</code> method is called, which redirects the browser to SKY API&#x2019;s authorization endpoint to start the authentication and authorization process. The user must authenticate with their Blackbaud credentials (if they are not already signed in) and authorize your application to access their SKY API data.</p>
<pre><code class="language-php">&lt;?php
class Auth {
  public static function redirect() {
    $auth_uri = self::getAuthorizationUri();
    header(&quot;Location: $auth_uri&quot;, true, 301);
    exit();
  }
    ...
  private static function getAuthorizationUri() {
    return AUTH_BASE_URI . &apos;authorization?&apos; . 
      http_build_query(array(
        &apos;client_id&apos;=&gt; AUTH_CLIENT_ID,
        &apos;response_type&apos; =&gt; &apos;code&apos;,
        &apos;redirect_uri&apos; =&gt; AUTH_REDIRECT_URI
      ));
  }
    ...</code></pre></li>
<li><p>Once authorized, SKY API redirects the user back to the <code>/auth/callback.php</code> URI with an authorization code. Once an authorization code has been obtained, it exchanges the code for an access token.  The app is then redirected back to the Home page.</p>
<pre><code class="language-php">&lt;?php
require_once &apos;../includes/blackbaud/blackbaud.php&apos;;

blackbaud\Auth::exchangeCodeForAccessToken($_GET[&apos;code&apos;]);

header(&apos;Location: /&apos;);
exit();

    ...
// build out the request body with the code from the redirect URI, and call the fetchTokens() method, passing the newly made $body array.
public static function exchangeCodeForAccessToken($code = 0) {
$body = array(
    &apos;code&apos; =&gt; $code,
    &apos;grant_type&apos; =&gt; &apos;authorization_code&apos;,
    &apos;redirect_uri&apos; =&gt; AUTH_REDIRECT_URI
);
return self::fetchTokens($body);
}
    ...
// build out the appropriate token headers, and make the reqeust to the SKY API endpoint.   Grab the returned JSON response and
// store the tokens in the Session.
private static function fetchTokens($body = array()) {
$headers = array(
    &apos;Content-type: application/x-www-form-urlencoded&apos;,
    &apos;Authorization: Basic &apos; . base64_encode(AUTH_CLIENT_ID . &apos;:&apos; . AUTH_CLIENT_SECRET)
);

$url = AUTH_BASE_URI . &apos;token&apos;;

$response = Http::post($url, $body, $headers);
$token = json_decode($response, true);
Session::setToken($token);
return $response;
}
</code></pre></li>
</ol>

<h2 id="retrieve-constituent-data">Retrieve Constituent Data</h2>
<ol>
<li>Open the <strong>index.html</strong> file.</li>
<li><p>AngularJS again makes the request to <code>auth/authenticated</code>, which now returns <code>true</code>. Since the user is authorized, AngularJS then makes a request the application&#x2019;s constituent API endpoint <code>/api/constituents.php?id=280</code> to retrieve a constituent record.</p>
<pre><code class="language-javascript">angular.module(&apos;AuthCodeFlowTutorial&apos;, [])
    .controller(&apos;ConstituentCtrl&apos;, function ($scope, $http, $watch) {

       // Check user access token.
        $http.get(&apos;/auth/authenticated.php&apos;).then(res =&gt; {
          $scope.isAuthenticated = res.data.authenticated;
          if ($scope.isAuthenticated === false) {
            $scope.isReady = true;
            return;
          }

          // Access token is valid. Fetch constituent record.
          $http.get(&apos;/api/constituents.php?id=280&apos;).then(res =&gt; {
            $scope.constituent = res.data.constituent;
            $scope.isReady = true;
          });
        });
        ...</code></pre>
</li>
 <li>Open <strong>api/constituents.php</strong> and <strong>includes/blackbaud/api/constituents.php</strong>.</li>
  <li>
    <p>The get request in <strong>index.html</strong> file directs the request to <strong>api/constituents.php</strong>, where the access token is refreshed and the call is passed along to <strong>/includes/blackbaud/api/constituents.php</strong> with the id from the route param <code>?id=280</code> that we passed into the request.</p> 
    <pre><code class="language-php">&lt;?php
    ...
   $response = blackbaud\Auth::refreshAccessToken();
    $token = json_decode($response, true);
    if (!isset($token[&apos;access_token&apos;])) {
      echo json_encode($token);
      return;
    }
    $data = blackbaud\Constituents::getById($_GET[&apos;id&apos;]);
    ...</code></pre>

    <p>
        The <code>getById()</code> method interacts directly with the SKY API endpoints making a <code>get</code> request to the <code>https://api.sky.blackbaud.com/constituent/v1/constituents/280</code> endpoint and passing in the required <code>headers</code>.
    </p>
    <pre><code class="language-php">&lt;?php
    ...
        self::$headers = array(
        &apos;Bb-Api-Subscription-Key: &apos; . AUTH_SUBSCRIPTION_KEY,
        &apos;Authorization: Bearer &apos; . Session::getAccessToken(),
        &apos;Content-type: application/x-www-form-urlencoded&apos;
        );
        self::$baseUri = SKY_API_BASE_URI . &apos;constituent/v1/&apos;;
    }

    public static function getById($id = 0) {
        $url = self::$baseUri . &apos;constituents/&apos; . $id;
        $response = Http::get($url, self::$headers);
        return json_decode($response, true);
    }
    ...</code></pre>

    <p>The <code>Bb-Api-Subscription-Key</code> value represents your Blackbaud developer account&apos;s approved subscription to an API product. You can use your account&apos;s <strong>Primary key</strong> or <strong>Secondary key</strong>. The <code>Authorization</code> value represents your authorization to use the API. The <code>Authorization</code> header starts with <code>Bearer</code> followed by a space and then the value for the access token.</p>
      <p>A call to the  <a href="https://developer.sky.blackbaud.com/docs/services/56b76470069a0509c8f1c5b3/operations/GetConstituent">Constituent (Get) endpoint</a> retrieves constituent data and sends it back to the browser.</p>
    <pre><code class="language-javascript"><br>function get(request, endpoint, callback) {
    return proxy(request, &apos;GET&apos;, endpoint, &apos;&apos;, callback);
}</code></pre>
    <p>The data is returned as JSON to the browser where the model&apos;s data is projected through the view of the Angular template.</p>
    <pre><code class="language-markup" ng-non-bindable="">&lt;div ng-if=&quot;isAuthenticated&quot;&gt;
  &lt;h3&gt;Constituent: {{ constituent.name }}&lt;/h3&gt;
  &lt;p&gt;
    See &lt;a href=&quot;https://developer.sky.blackbaud.com/contract-reference#Constituent&quot; target=&quot;_blank&quot;&gt;Constituent&lt;/a&gt;
    within the SKY API contact reference for a full listing of properties.
  &lt;/p&gt;
  &lt;div class=&quot;table-responsive&quot;&gt;
    &lt;table class=&quot;table table-striped table-hover&quot;&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;Name&lt;/th&gt;
          &lt;th&gt;Value&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody&gt;
        &lt;tr&gt;
          &lt;td&gt;id&lt;/td&gt;
          &lt;td&gt;{{ constituent.id }}&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;type&lt;/td&gt;
          &lt;td&gt;{{ constituent.type }}&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;lookup_id&lt;/td&gt;
          &lt;td&gt;{{ constituent.lookup_id }}&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;first&lt;/td&gt;
          &lt;td&gt;{{ constituent.first }}&lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
          &lt;td&gt;last&lt;/td&gt;
          &lt;td&gt;{{ constituent.last }}&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;
  &lt;a href=&quot;/auth/logout&quot; class=&quot;btn btn-primary&quot;&gt;Log out&lt;/a&gt;
&lt;/div&gt;</code></pre>
    <p><img src="/assets/img/auth_tutorial_GETConstituent.png" alt="GET Constituent"></p>
  </li>
<li>Once the constituent information is retrieved and added to the front page, <strong>Log Out</strong> and <strong>Refresh Access Token</strong> buttons are displayed.</li>
<li>Open <strong>/auth/logout.php</strong> and <strong>includes/blackbaud/session.php</strong>.</li>
<li>If the user selects <strong>Log Out</strong>, they are redirected to <strong>/auth/logout.php</strong>, which calls the <code>blackbaud\Session::logout()</code> in <strong>includes/blackaud/session.php</strong>. The <code>logout()</code> method destroys the token stored in the PHP server&apos;s <code>$_SESSION</code>.</li>
    <pre><code class="language-php">&lt;?php
    ...
    public static function logout() {
      unset($_SESSION[self::$tokenName]);
    }
    ...</code></pre>

<li>If the user selects <strong>Refresh Access Token</strong>, AngularJS makes a request to <strong>/auth/refresh-token.php</strong>. The call is passed to the <code>refreshAccessToken()</code> method in <strong>includes/blackbaud/auth.php</strong>, which builds out the request body with the required fields.  The <code>grant_type</code> is set to <code>refresh_token</code> and the <code>refresh_token</code> field is populated with the <strong>refresh_token</strong> we have stored in the <code>$_SESSION</code>. This body is then passed to the <code>fetchTokens()</code> method where the <code>post</code> to the SKY API endpoint is made.</li>

  <pre><code class="language-php">&lt;?php
  ...
  public static function refreshAccessToken() {
    $body = array(
      &apos;grant_type&apos; =&gt; &apos;refresh_token&apos;,
      &apos;refresh_token&apos; =&gt; Session::getRefreshToken()
    );
    return self::fetchTokens($body);
  }
  ...
    private static function fetchTokens($body = array()) {
    $headers = array(
      &apos;Content-type: application/x-www-form-urlencoded&apos;,
      &apos;Authorization: Basic &apos; . base64_encode(AUTH_CLIENT_ID . &apos;:&apos; . AUTH_CLIENT_SECRET)
    );

    $url = AUTH_BASE_URI . &apos;token&apos;;

    $response = Http::post($url, $body, $headers);
    $token = json_decode($response, true);
    Session::setToken($token);
    return $response;
  }
  ...
  </code></pre>

  <p>
    The <code>JSON</code> response from SKY API is then parsed, the new set of tokens are stored in our <code>$_SESSION</code>, and the data is sent back to Angular to be displayed on the page for your reference.
  </p>
</ol>

<p>That&apos;s it!</p>
<ul>
<li>Be sure to take a look at our other <a href="/docs/code/">code samples</a>.</li>
<li>You can <a href="https://github.com/blackbaud/sky-api-tutorial-auth-code-php/issues">create an issue</a> to report a bug or request a feature for this code sample.  For all other feature requests, see <a href="/support/ideas/">ideas</a>.</li>
</ul>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//sky-api.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
</div>

        
      </div>
    </div>
  </div>
</div>

        
      

      

      
        <div class="back-to-top" data-offset="220">
  <i class="fa fa-angle-double-up"></i>
</div>
      

      <div class="affix-stop">
        

        
          

            <div class="footer-site">
              <div class="container">
                <div class="row">
                  <div class="col-xs-6 col-sm-4">
                    <h3>
  <a href="https://developer.sky.blackbaud.com/">
    SKY API
  </a>
</h3>
                    <ul class="nav navbar-nav navbar-left">
  <li>
    <a href="https://developer.sky.blackbaud.com/">
      Home
    </a>
  </li>
  <li class="dropdown">
    <a href="/docs/getting-started/">
      Documentation
      <span class="caret"></span>
    </a>
  </li>
  <li class="dropdown">
    <a href="https://developer.sky.blackbaud.com/docs/services/">
      API
      <span class="caret"></span>
    </a>
  </li>
  <li class="dropdown">
    <a href="https://developer.sky.blackbaud.com/developer/">
      Developer Account
      <span class="caret"></span>
    </a>
  </li>
  <li class="dropdown">
    <a href="/support/changelog/">
      Support
      <span class="caret"></span>
    </a>
  </li>
  <li class="terms">
    <a href="https://developer.sky.blackbaud.com/terms">
      API Terms of Use
    </a>
  </li>
</ul>
                  </div>
                  <div class="col-xs-6 col-sm-4 col-sm-push-4">
                    <ul class="list-inline social-icons">
  <li>
    <a href="http://twitter.com/blackbaud" target="_blank">
      <i class="fa fa-twitter"></i>
    </a>
  </li>
  <li>
    <a href="https://www.facebook.com/blackbaud" target="_blank">
      <i class="fa fa-facebook"></i>
    </a>
  </li>
  <li>
    <a href="http://www.youtube.com/user/blackbaudinc" target="_blank">
      <i class="fa fa-youtube"></i>
    </a>
  </li>
</ul>
                  </div>
                  <div class="clearfix visible-xs-block"></div>
                  <div class="col-sm-4 col-sm-pull-4">
                    
                  </div>
                </div>
              </div>
            </div>

          
        

        
          
            <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <p>&copy; 2016 Blackbaud, Inc. All rights reserved.</p>
            </div>
        </div>
    </div>
</div>
          
        
      </div>

      
        <bb-omnibar></bb-omnibar>
<bb-omnibar-search-results></bb-omnibar-search-results>
      

      
        <script src="https://sky.blackbaudcdn.net/skyux/1.16.0-4/js/sky-bundle.min.js"></script>
      

      

      <script src="/js/stache.min.js"></script>

      
        
      
        
      
        
      
        
      

      
        
          <script src="/assets/js/scrollreveal.js"></script>
        
      
        
          <script src="/assets/js/custom.js"></script>
        
      
        
          <script src="/assets/js/angular-local-storage.min.js"></script>
        
      
        
          <script src="/assets/js/entity-reference/app.1.2.js"></script>
        
      

      

      

      
        
          <script>
            !function(e,a){"use strict";function n(){var e={};try{e.omnibar={enableHelp:!1,enableSearch:!0,serviceName:"SKY API",serviceNameLink:"https://developer.sky.blackbaud.com/",enableServiceNameLink:!0,url:"https://signin.blackbaud.com/omnibar.min.js",urlDev:"https://signin.blackbaud.com/omnibar.min.js",delegationUri:"https://developer.sky.blackbaud.com/signin/"},e.omnibarSearch={resultsBaseUri:"",resourceUrl:"/content.json",resultsTemplateUri:"/assets/vendor/bb-omnibar-search/templates/bb-omnibar-search.hbs",searchFormClass:"searchenabled",searchFormClassDev:"bb-omnibar-searchenabled",searchInputId:"omnibar_searchbox",searchResultsId:"bb-omnibar-search-results"}}catch(e){}return e}function r(e,a){e.$on("bbBeginWait",function(e,n){e.stopPropagation(),a.beginPageWait(n)}),e.$on("bbEndWait",function(e,n){e.stopPropagation(),a.endPageWait(n)})}r.$inject=["$rootScope","bbWait"],a.module("stache").constant("stacheConfig",n.call()).run(r),a.element(document).ready(function(){a.bootstrap(document,["stache"])})}(window,window.angular);
          </script>
        
      

      

    </body>
  </html>

